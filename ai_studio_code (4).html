<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Vocabulary Learning</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Optional: Add custom styles if needed, though Tailwind should cover most. */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">Smart Vocabulary Learning</h1>
            <div id="loggedInUserDisplay" class="hidden text-xl font-semibold">
                Welcome, <span id="currentUsername"></span>!
            </div>
            <nav id="mainNav" class="hidden">
                <button id="homeNavBtn" class="bg-white text-purple-700 py-2 px-4 rounded-full shadow hover:bg-purple-100 transition duration-300">Home</button>
                <button id="wordBankNavBtn" class="bg-white text-purple-700 py-2 px-4 rounded-full shadow ml-2 hover:bg-purple-100 transition duration-300">Word Bank</button>
                <button id="reviewNavBtn" class="bg-white text-purple-700 py-2 px-4 rounded-full shadow ml-2 hover:bg-purple-100 transition duration-300">Start Review</button>
                <button id="logoutBtnHeader" class="bg-red-500 text-white py-2 px-4 rounded-full shadow ml-2 hover:bg-red-600 transition duration-300">Logout</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">

        <!-- Account Interface -->
        <section id="accountView" class="view active bg-white p-6 rounded-lg shadow-xl max-w-md mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Account Management</h2>
            <div class="flex flex-col gap-4 mb-6">
                <input type="text" id="usernameInput" placeholder="Enter username" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                <button id="createAccountBtn" class="bg-purple-600 text-white py-3 px-6 rounded-lg shadow hover:bg-purple-700 transition duration-300 transform hover:scale-105 font-semibold text-lg">Create New Account</button>
                <button id="loginAccountBtn" class="bg-indigo-600 text-white py-3 px-6 rounded-lg shadow hover:bg-indigo-700 transition duration-300 transform hover:scale-105 font-semibold text-lg">Login</button>
            </div>
            <p id="accountMessage" class="text-center mt-4 text-sm text-red-600 hidden"></p>
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Existing Accounts:</h3>
                <ul id="accountList" class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded-lg bg-gray-50">
                    <!-- Accounts will be listed here -->
                </ul>
            </div>
        </section>

        <!-- Home (Word Input Page) -->
        <section id="homeView" class="view bg-white p-6 rounded-lg shadow-xl max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Add New Word</h2>
            <div class="flex flex-col gap-4 mb-6">
                <input type="text" id="englishWordInput" placeholder="English Word (e.g., Ephemeral)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                <input type="text" id="chineseMeaningInput" placeholder="Chinese Meaning (e.g., 短暂的)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                <textarea id="explanationInput" placeholder="Explanation or Example Sentence" rows="3" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg"></textarea>
                <button id="addWordBtn" class="bg-purple-600 text-white py-3 px-6 rounded-lg shadow hover:bg-purple-700 transition duration-300 transform hover:scale-105 font-semibold text-lg">Add Word</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="goToWordBankBtn" class="bg-indigo-600 text-white py-3 px-6 rounded-lg shadow hover:bg-indigo-700 transition duration-300 transform hover:scale-105 font-semibold text-lg">Go to Word Bank</button>
                <button id="startReviewBtn" class="bg-green-600 text-white py-3 px-6 rounded-lg shadow hover:bg-green-700 transition duration-300 transform hover:scale-105 font-semibold text-lg">Start Review</button>
            </div>
            <div class="text-center mt-8">
                <button id="logoutBtnHome" class="bg-gray-300 text-gray-800 py-3 px-6 rounded-lg shadow hover:bg-gray-400 transition duration-300 transform hover:scale-105 font-semibold text-lg">Logout</button>
            </div>
            <p id="saveMessage" class="text-center mt-4 text-sm text-green-600 hidden">Word saved successfully!</p>
            <p id="homeErrorMessage" class="text-center mt-4 text-sm text-red-600 hidden">Please fill in all fields.</p>
        </section>

        <!-- Word Bank -->
        <section id="wordBankView" class="view bg-white p-6 rounded-lg shadow-xl max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Word Bank</h2>
            <div id="wordList" class="space-y-4">
                <!-- Words will be dynamically loaded here -->
            </div>
            <div class="text-center mt-8">
                <button id="backToHomeFromBankBtn" class="bg-gray-300 text-gray-800 py-3 px-6 rounded-lg shadow hover:bg-gray-400 transition duration-300 transform hover:scale-105 font-semibold text-lg">Back to Home</button>
            </div>
            <p id="emptyBankMessage" class="text-center mt-4 text-gray-500 hidden">Your word bank is empty. Add some words!</p>
        </section>

        <!-- Review Interface -->
        <section id="reviewView" class="view bg-white p-6 rounded-lg shadow-xl max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Review Your Vocabulary</h2>

            <!-- Review Card -->
            <div id="reviewCard" class="bg-purple-50 p-8 rounded-lg shadow-inner text-center min-h-[300px] flex flex-col justify-center items-center relative">
                <p id="reviewMode" class="absolute top-4 left-4 text-xs text-purple-400 uppercase font-semibold"></p>
                
                <h3 id="currentEnglishWordDisplay" class="text-4xl font-extrabold text-purple-800 mb-4"></h3>
                <p id="currentChineseMeaningDisplay" class="text-2xl text-gray-700 font-semibold mb-2"></p>
                <p id="currentExplanationDisplay" class="text-xl text-gray-600 italic mb-6"></p>

                <div id="flashcardControls" class="flex flex-col gap-4">
                    <button id="flipCardBtn" class="bg-purple-500 text-white py-3 px-6 rounded-lg shadow hover:bg-purple-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Flip Card</button>
                </div>
                <div id="spellingControls" class="flex flex-col gap-4 hidden w-full max-w-md">
                    <input type="text" id="spellingInput" placeholder="Type the English word here" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                    <button id="checkSpellingBtn" class="bg-blue-500 text-white py-3 px-6 rounded-lg shadow hover:bg-blue-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Check Word</button>
                    <p id="spellingFeedback" class="text-lg font-semibold mt-2"></p>
                </div>
                <div id="fillInBlankControls" class="flex flex-col gap-4 hidden w-full max-w-md">
                    <p id="sentenceDisplay" class="text-xl text-gray-700 italic mb-4"></p>
                    <input type="text" id="blankInput" placeholder="Fill in the blank" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                    <button id="checkBlankBtn" class="bg-teal-500 text-white py-3 px-6 rounded-lg shadow hover:bg-teal-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Check Answer</button>
                    <p id="blankFeedback" class="text-lg font-semibold mt-2"></p>
                </div>
            </div>

            <div id="reviewNavigation" class="flex justify-center items-center gap-4 mt-8">
                <button id="easyBtn" class="bg-green-500 text-white py-3 px-6 rounded-lg shadow hover:bg-green-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Easy</button>
                <button id="hardBtn" class="bg-red-500 text-white py-3 px-6 rounded-lg shadow hover:bg-red-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Hard</button>
                <button id="nextReviewWordBtn" class="bg-blue-500 text-white py-3 px-6 rounded-lg shadow hover:bg-blue-600 transition duration-300 transform hover:scale-105 font-semibold text-lg">Next Word</button>
            </div>

            <div class="text-center mt-8">
                <button id="backToHomeFromReviewBtn" class="bg-gray-300 text-gray-800 py-3 px-6 rounded-lg shadow hover:bg-gray-400 transition duration-300 transform hover:scale-105 font-semibold text-lg">Back to Home</button>
            </div>
            <p id="reviewCompleteMessage" class="text-center mt-4 text-xl text-green-700 hidden">Review session complete!</p>
            <p id="reviewEmptyMessage" class="text-center mt-4 text-xl text-gray-500 hidden">Your word bank is empty. Add words to start a review!</p>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center mt-8">
        <p class="text-sm">Built with ❤️ for learning</p>
    </footer>

    <script>
        const VIEWS = {
            ACCOUNT: 'accountView',
            HOME: 'homeView',
            WORD_BANK: 'wordBankView',
            REVIEW: 'reviewView'
        };

        let currentView = VIEWS.ACCOUNT;
        let currentUsername = null;
        let vocabulary = []; // Will be loaded based on currentUsername
        let reviewWords = [];
        let currentReviewIndex = 0;
        let reviewMode = 'flashcard'; // 'flashcard', 'spelling', 'fill-in-the-blank'

        // Elements
        const accountView = document.getElementById(VIEWS.ACCOUNT);
        const homeView = document.getElementById(VIEWS.HOME);
        const wordBankView = document.getElementById(VIEWS.WORD_BANK);
        const reviewView = document.getElementById(VIEWS.REVIEW);

        // Account Elements
        const usernameInput = document.getElementById('usernameInput');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const loginAccountBtn = document.getElementById('loginAccountBtn');
        const accountMessage = document.getElementById('accountMessage');
        const accountList = document.getElementById('accountList');
        const currentUsernameDisplay = document.getElementById('currentUsername');
        const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
        const mainNav = document.getElementById('mainNav');

        // Home Elements
        const englishWordInput = document.getElementById('englishWordInput');
        const chineseMeaningInput = document.getElementById('chineseMeaningInput');
        const explanationInput = document.getElementById('explanationInput');
        const addWordBtn = document.getElementById('addWordBtn');
        const saveMessage = document.getElementById('saveMessage');
        const homeErrorMessage = document.getElementById('homeErrorMessage');
        const goToWordBankBtn = document.getElementById('goToWordBankBtn');
        const startReviewBtn = document.getElementById('startReviewBtn');
        const logoutBtnHome = document.getElementById('logoutBtnHome');
        const logoutBtnHeader = document.getElementById('logoutBtnHeader');

        // Word Bank Elements
        const wordList = document.getElementById('wordList');
        const backToHomeFromBankBtn = document.getElementById('backToHomeFromBankBtn');
        const emptyBankMessage = document.getElementById('emptyBankMessage');

        // Review Elements
        const reviewCard = document.getElementById('reviewCard');
        const reviewModeDisplay = document.getElementById('reviewMode');
        const currentEnglishWordDisplay = document.getElementById('currentEnglishWordDisplay');
        const currentChineseMeaningDisplay = document='currentChineseMeaningDisplay';
        const currentExplanationDisplay = document.getElementById('currentExplanationDisplay');
        const flipCardBtn = document.getElementById('flipCardBtn');
        const easyBtn = document.getElementById('easyBtn');
        const hardBtn = document.getElementById('hardBtn');
        const nextReviewWordBtn = document.getElementById('nextReviewWordBtn');
        const backToHomeFromReviewBtn = document.getElementById('backToHomeFromReviewBtn');
        const reviewCompleteMessage = document.getElementById('reviewCompleteMessage');
        const reviewEmptyMessage = document.getElementById('reviewEmptyMessage');
        const reviewNavigation = document.getElementById('reviewNavigation');

        const flashcardControls = document.getElementById('flashcardControls');
        const spellingControls = document.getElementById('spellingControls');
        const spellingInput = document.getElementById('spellingInput');
        const checkSpellingBtn = document.getElementById('checkSpellingBtn');
        const spellingFeedback = document.getElementById('spellingFeedback');
        const fillInBlankControls = document.getElementById('fillInBlankControls');
        const sentenceDisplay = document.getElementById('sentenceDisplay');
        const blankInput = document.getElementById('blankInput');
        const checkBlankBtn = document.getElementById('checkBlankBtn');
        const blankFeedback = document.getElementById('blankFeedback');

        // Navigation Buttons (Header)
        const homeNavBtn = document.getElementById('homeNavBtn');
        const wordBankNavBtn = document.getElementById('wordBankNavBtn');
        const reviewNavBtn = document.getElementById('reviewNavBtn');

        // --- LocalStorage Management ---
        function getAccounts() {
            return JSON.parse(localStorage.getItem('accounts')) || [];
        }

        function saveAccounts(accounts) {
            localStorage.setItem('accounts', JSON.stringify(accounts));
        }

        function getVocabularyForUser(username) {
            return JSON.parse(localStorage.getItem(`vocab_${username}`)) || [];
        }

        function saveVocabularyForUser(username, vocabData) {
            localStorage.setItem(`vocab_${username}`, JSON.stringify(vocabData));
        }

        // --- View Management ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            currentView = viewId;

            // Update header visibility and username
            if (currentUsername) {
                loggedInUserDisplay.classList.remove('hidden');
                currentUsernameDisplay.textContent = currentUsername;
                mainNav.classList.remove('hidden');
            } else {
                loggedInUserDisplay.classList.add('hidden');
                mainNav.classList.add('hidden');
            }

            // Specific actions for views
            if (viewId === VIEWS.ACCOUNT) {
                renderAccountList();
            } else if (viewId === VIEWS.WORD_BANK) {
                renderWordBank();
            } else if (viewId === VIEWS.REVIEW) {
                startReviewSession();
            }
        }

        // --- Account Interface Logic ---
        function renderAccountList() {
            accountList.innerHTML = '';
            const accounts = getAccounts();
            if (accounts.length === 0) {
                accountList.innerHTML = '<li class="text-center text-gray-500">No accounts created yet.</li>';
            } else {
                accounts.forEach(acc => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm hover:bg-gray-100 transition duration-200 cursor-pointer';
                    li.innerHTML = `
                        <span class="text-gray-800 font-medium">${acc}</span>
                        <button class="login-account-item-btn bg-blue-100 text-blue-700 py-1 px-3 rounded-full text-sm hover:bg-blue-200" data-username="${acc}">Login</button>
                    `;
                    accountList.appendChild(li);
                });

                document.querySelectorAll('.login-account-item-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const username = event.target.dataset.username;
                        loginUser(username);
                    });
                });
            }
        }

        function displayAccountMessage(message, isError = true) {
            accountMessage.textContent = message;
            accountMessage.classList.remove('hidden');
            if (isError) {
                accountMessage.classList.remove('text-green-600');
                accountMessage.classList.add('text-red-600');
            } else {
                accountMessage.classList.remove('text-red-600');
                accountMessage.classList.add('text-green-600');
            }
            setTimeout(() => accountMessage.classList.add('hidden'), 3000);
        }

        createAccountBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                let accounts = getAccounts();
                if (accounts.includes(username)) {
                    displayAccountMessage('Account with this username already exists.');
                } else {
                    accounts.push(username);
                    saveAccounts(accounts);
                    displayAccountMessage(`Account "${username}" created successfully!`, false);
                    usernameInput.value = '';
                    renderAccountList();
                }
            } else {
                displayAccountMessage('Please enter a username.');
            }
        });

        loginAccountBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                loginUser(username);
            } else {
                displayAccountMessage('Please enter a username to log in.');
            }
        });

        function loginUser(username) {
            let accounts = getAccounts();
            if (accounts.includes(username)) {
                currentUsername = username;
                vocabulary = getVocabularyForUser(username);
                showView(VIEWS.HOME);
                usernameInput.value = '';
                displayAccountMessage(`Logged in as "${username}"`, false);
            } else {
                displayAccountMessage('Account not found. Please create it or check username.');
            }
        }

        function logoutUser() {
            currentUsername = null;
            vocabulary = [];
            showView(VIEWS.ACCOUNT);
        }

        logoutBtnHome.addEventListener('click', logoutUser);
        logoutBtnHeader.addEventListener('click', logoutUser);


        // --- Home View Logic ---
        addWordBtn.addEventListener('click', () => {
            const englishWord = englishWordInput.value.trim();
            const chineseMeaning = chineseMeaningInput.value.trim();
            const explanation = explanationInput.value.trim();

            if (englishWord && chineseMeaning && explanation) {
                vocabulary.push({
                    english: englishWord,
                    chinese: chineseMeaning,
                    explanation: explanation,
                    repetition: 0,
                    interval: 1,
                    easinessFactor: 2.5,
                    nextReview: new Date()
                });
                saveVocabularyForUser(currentUsername, vocabulary);
                englishWordInput.value = '';
                chineseMeaningInput.value = '';
                explanationInput.value = '';
                saveMessage.classList.remove('hidden');
                homeErrorMessage.classList.add('hidden');
                setTimeout(() => saveMessage.classList.add('hidden'), 2000);
            } else {
                homeErrorMessage.classList.remove('hidden');
                saveMessage.classList.add('hidden');
            }
        });

        goToWordBankBtn.addEventListener('click', () => showView(VIEWS.WORD_BANK));
        startReviewBtn.addEventListener('click', () => showView(VIEWS.REVIEW));

        // --- Word Bank Logic ---
        function renderWordBank() {
            wordList.innerHTML = '';
            if (vocabulary.length === 0) {
                emptyBankMessage.classList.remove('hidden');
            } else {
                emptyBankMessage.classList.add('hidden');
                vocabulary.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition duration-300 border border-gray-200 relative';
                    card.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${item.english}</h3>
                        <p class="text-lg text-indigo-700 mb-2"><strong>Chinese:</strong> ${item.chinese}</p>
                        <p class="text-gray-600 mb-4"><strong>Explanation:</strong> ${item.explanation}</p>
                        <button class="delete-word-btn absolute top-3 right-3 text-red-500 hover:text-red-700 font-semibold text-sm py-1 px-2 rounded-md bg-red-100" data-index="${index}">Delete</button>
                    `;
                    wordList.appendChild(card);
                });
                document.querySelectorAll('.delete-word-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const indexToDelete = parseInt(event.target.dataset.index);
                        vocabulary.splice(indexToDelete, 1);
                        saveVocabularyForUser(currentUsername, vocabulary);
                        renderWordBank(); // Re-render the list
                    });
                });
            }
        }

        backToHomeFromBankBtn.addEventListener('click', () => showView(VIEWS.HOME));

        // --- Review Interface Logic ---
        function calculateNextReview(word, quality) {
            const now = new Date();
            let easinessFactor = word.easinessFactor;
            let interval = word.interval;

            // Clamp quality between 0 and 5
            quality = Math.max(0, Math.min(5, quality));

            if (quality >= 3) { // Correct answer (3, 4, 5)
                if (word.repetition === 0) {
                    interval = 1;
                } else if (word.repetition === 1) {
                    interval = 6;
                } else {
                    interval = Math.round(interval * easinessFactor);
                }
                word.repetition++;
            } else { // Incorrect answer (0, 1, 2)
                word.repetition = 0;
                interval = 1; // Reset interval to 1 day
            }

            // Update easiness factor
            easinessFactor = easinessFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (easinessFactor < 1.3) easinessFactor = 1.3; // Minimum EF

            word.easinessFactor = easinessFactor;
            word.interval = interval;
            word.nextReview = new Date(now.setDate(now.getDate() + interval));

            return word;
        }

        function startReviewSession() {
            reviewWords = vocabulary.filter(word => new Date(word.nextReview) <= new Date())
                                    .sort((a, b) => new Date(a.nextReview) - new Date(b.nextReview)); // Sort by next review date
            currentReviewIndex = 0;
            
            reviewCompleteMessage.classList.add('hidden');
            reviewEmptyMessage.classList.add('hidden');
            reviewNavigation.classList.remove('hidden');
            reviewCard.classList.remove('hidden');

            if (reviewWords.length === 0) {
                reviewEmptyMessage.classList.remove('hidden');
                reviewNavigation.classList.add('hidden');
                reviewCard.classList.add('hidden');
            } else {
                displayReviewWord();
            }
        }

        function displayReviewWord() {
            if (currentReviewIndex >= reviewWords.length) {
                reviewCompleteMessage.classList.remove('hidden');
                reviewCard.classList.add('hidden');
                reviewNavigation.classList.add('hidden');
                return;
            }

            const word = reviewWords[currentReviewIndex];
            
            currentEnglishWordDisplay.textContent = '';
            currentChineseMeaningDisplay.textContent = '';
            currentExplanationDisplay.textContent = '';
            
            // Randomly pick a review mode
            const modes = ['flashcard', 'spelling', 'fill-in-the-blank'];
            reviewMode = modes[Math.floor(Math.random() * modes.length)];
            reviewModeDisplay.textContent = `Mode: ${reviewMode.replace('-', ' ')}`;

            // Hide all controls first
            flashcardControls.classList.add('hidden');
            spellingControls.classList.add('hidden');
            fillInBlankControls.classList.add('hidden');
            spellingFeedback.textContent = '';
            blankFeedback.textContent = '';
            spellingInput.value = '';
            blankInput.value = '';

            if (reviewMode === 'flashcard') {
                flashcardControls.classList.remove('hidden');
                currentEnglishWordDisplay.textContent = word.english; // Show English word initially
                flipCardBtn.textContent = 'Flip Card';
            } else if (reviewMode === 'spelling') {
                spellingControls.classList.remove('hidden');
                currentChineseMeaningDisplay.textContent = word.chinese;
                currentExplanationDisplay.textContent = word.explanation;
            } else if (reviewMode === 'fill-in-the-blank') {
                fillInBlankControls.classList.remove('hidden');
                const blankSentence = word.explanation.replace(new RegExp(word.english, 'gi'), '_____');
                sentenceDisplay.textContent = blankSentence;
            }
        }

        flipCardBtn.addEventListener('click', () => {
            const word = reviewWords[currentReviewIndex];
            if (currentChineseMeaningDisplay.textContent === '') {
                currentChineseMeaningDisplay.textContent = word.chinese;
                currentExplanationDisplay.textContent = word.explanation;
                flipCardBtn.textContent = 'Hide Details';
            } else {
                currentChineseMeaningDisplay.textContent = '';
                currentExplanationDisplay.textContent = '';
                flipCardBtn.textContent = 'Flip Card';
            }
        });

        checkSpellingBtn.addEventListener('click', () => {
            const word = reviewWords[currentReviewIndex];
            if (spellingInput.value.trim().toLowerCase() === word.english.toLowerCase()) {
                spellingFeedback.textContent = 'Correct!';
                spellingFeedback.className = 'text-lg font-semibold mt-2 text-green-600';
            } else {
                spellingFeedback.textContent = `Incorrect. The English word was: ${word.english}`;
                spellingFeedback.className = 'text-lg font-semibold mt-2 text-red-600';
            }
        });

        checkBlankBtn.addEventListener('click', () => {
            const word = reviewWords[currentReviewIndex];
            if (blankInput.value.trim().toLowerCase() === word.english.toLowerCase()) {
                blankFeedback.textContent = 'Correct!';
                blankFeedback.className = 'text-lg font-semibold mt-2 text-green-600';
            } else {
                blankFeedback.textContent = `Incorrect. The English word was: ${word.english}`;
                blankFeedback.className = 'text-lg font-semibold mt-2 text-red-600';
            }
        });

        function handleReviewAnswer(quality) {
            if (currentReviewIndex < reviewWords.length) {
                const word = reviewWords[currentReviewIndex];
                const updatedWord = calculateNextReview(word, quality);

                // Update the original word in the vocabulary array
                const originalIndex = vocabulary.findIndex(vWord => vWord.english === updatedWord.english);
                if (originalIndex !== -1) {
                    vocabulary[originalIndex] = updatedWord;
                    saveVocabularyForUser(currentUsername, vocabulary);
                }

                currentReviewIndex++;
                displayReviewWord();
            }
        }

        easyBtn.addEventListener('click', () => handleReviewAnswer(5)); // Quality 5 for Easy
        hardBtn.addEventListener('click', () => handleReviewAnswer(1)); // Quality 1 for Hard
        nextReviewWordBtn.addEventListener('click', () => handleReviewAnswer(3)); // Default Quality 3 for Next (considered 'good')

        backToHomeFromReviewBtn.addEventListener('click', () => showView(VIEWS.HOME));

        // --- Header Navigation ---
        homeNavBtn.addEventListener('click', () => showView(VIEWS.HOME));
        wordBankNavBtn.addEventListener('click', () => showView(VIEWS.WORD_BANK));
        reviewNavBtn.addEventListener('click', () => showView(VIEWS.REVIEW));

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            showView(VIEWS.ACCOUNT);
        });
    </script>
</body>
</html>